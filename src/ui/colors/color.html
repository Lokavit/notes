<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colors</title>
    <link rel="stylesheet" href="./color.css">
</head>
<style>
    /* This approach works for internal style blocks too */
    body {
        --color-internal: #b42634;
    }
</style>

<body>
    <h1>Colors</h1>
    <ul class="colors"></ul>

    <script>
        // 获取页面上所有样式表
        console.log('获取页面上所有样式表:', document.styleSheets)

        // 丢弃第三方样式表(运行脚本与css需在同域名下，即第三方样式表无法获取自定义属性或样式)
        const isSameDomain = (styleSheet) => {
            if (!styleSheet.href) return true;
            return styleSheet.href.indexOf(window.location.origin) === 0;
        }

        /**
            放弃任何不是CSSStyleRule 基本样式规则的规则
            See: https://developer.mozilla.org/en-US/docs/Web/API/CSSRule#Type_constants
        */
        const isStyleRule = (rule) => rule.type === 1;

        /**
         * 在页面上获取所有自定义属性
         * @return array<array[string, string]>
         * ex; [["--color-accent", "#b9f500"], ["--color-text", "#252525"], ...]
         */
        const getCSSCustomPropIndex = () => [...document.styleSheets]
            // 过滤掉第三方样式表
            .filter(isSameDomain)
            /**
                获取其余样式表的所有规则(组合循环找到想要的值，并组合) 最后的[]表示从空数组开始
                注意:必须是线上，若是本地则会报错(cssRules css规则)
                返回: color.css中所有样式{}以及本页面的css。所有选择器
            */
            .reduce((finalArr, sheet) => finalArr.concat(
                // 过滤掉任何不是基本样式规则的规则
                [...sheet.cssRules].filter(isStyleRule)
                    /**
                        获取所有属性的属性名和属性值
                    */
                    .reduce((propArr, rule) => {
                        // styleMap替代方案，该方案尚在草稿期
                        const props = [...rule.styleMap.entries()]
                            // 改为以上一句代码
                            // const props = [...rule.style].map((propName) => [
                            //     propName.trim(),
                            //     rule.style.getPropertyValue(propName).trim()
                            // ])
                            // 过滤掉非自定义属性，即没有--的属性
                            .filter(([propName]) => propName.indexOf('--') === 0)
                        return [...propArr, ...props];
                    }, [])
            ), []);
        console.log('类数组转数组:', getCSSCustomPropIndex());

        // 定义变量
        const cssCostomPropIndex = getCSSCustomPropIndex();
        
        // 遍历生成色板
        document.querySelector('.colors').innerHTML = cssCostomPropIndex.reduce(
            (str, [prop, val]) => `
            ${str}<li class="color">
                    <b class ="color__swatch" style="--color:${val}"></b>
                    <div class="color__details">
                        <input value="${prop}" readonly />
                        <input value="${val}" readonly />
                    </div>
                </li>`, "");
    </script>
</body>

</html>